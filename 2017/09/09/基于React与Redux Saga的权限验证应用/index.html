<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Perkin在 Github 上的个人博客">
    <meta name="keyword" content="perkinzone">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="http://oum6ifofe.bkt.clouddn.com/about.ico">
    <link rel="alternate" type="application/atom+xml" title="Perkin" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        基于React与Redux Saga的权限验证应用(一)｜Perkin
        
    </title>

    <link rel="canonical" href="http://perkinj.github.io/2017/09/09/基于React与Redux Saga的权限验证应用/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('http://oum6ifofe.bkt.clouddn.com/image/home.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    Perkin
                </span>
                的博客
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/Tags/">
                            标签
                            </a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/about/">
                            关于我
                            </a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/archives/">
                            归档
                            </a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="http://oum6ifofe.bkt.clouddn.com/image/default.jpg">


<style>
    
    header.intro-header {
        background-image: url('http://oum6ifofe.bkt.clouddn.com/image/default.jpg')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>基于React与Redux Saga的权限验证应用(一)</h1>
                    
                    <span class="meta">
                         作者 Perkin
                        <span>
                          日期 2017-09-09
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#react"
                           title="react">react</a>
                        
                        <a class="tag" href="/tags/#redux-saga"
                           title="redux-saga">redux-saga</a>
                        
                        <a class="tag" href="/tags/#redux-form"
                           title="redux-form">redux-form</a>
                        
                        <a class="tag" href="/tags/#JWT"
                           title="JWT">JWT</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            基于React与Redux Saga的权限验证应用(一)
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <blockquote>
<p>本文是基于<a href="https://start.jcolemorrison.com/react-and-redux-sagas-authentication-app-tutorial/" target="_blank" rel="external">React and Redux Sagas Authentication App Tutorial</a>翻译整理，并总结而来，目的是学习redux-saga以及redux-form以及JWT形式的验证方式。</p>
</blockquote>
<p>知识点</p>
<ul>
<li>Redux-Saga的理解以及使用</li>
<li>Redux-Form的使用</li>
<li>登陆与权限验证,JWT的使用与原理</li>
</ul>
<p>本文就以上问题来展开深入讨论，项目的code已经放在<a href="https://github.com/PerkinJ/redux-saga-demo" target="_blank" rel="external">github</a>上。</p>
<h3 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h3><h4 id="1-建立API"><a href="#1-建立API" class="headerlink" title="1. 建立API"></a>1. 建立API</h4><p>本文主要了解react方面的技术栈，所以对api相关的创建，这里不做介绍，后文统一使用<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">http://widgetizer.jcolemorrison.com</div></pre></td></tr></table></figure></p>
<p>为接口，该API的作者会对注册的数据保存24小时。</p>
<blockquote>
<p>注意：如果您要运行本demo，可以使用.env环境的API,内容如下。一定要以REACT<em>APP
</em>*开头，因为create-react-app脚手架有对环境变量做限制。<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">REACT_APP_API_URL=http://widgetizer.jcolemorrison.com</div></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="2-建立脚手架"><a href="#2-建立脚手架" class="headerlink" title="2. 建立脚手架"></a>2. 建立脚手架</h4><p>a) 确认安装了create-react-app<br><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">npm install -g create-react-app</div></pre></td></tr></table></figure></p>
<p>b) 创建目录，并进入<br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mkdir app </div><div class="line"><span class="built_in">cd</span> app</div></pre></td></tr></table></figure></p>
<p>c) 运行<br><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">create-react-app .</div></pre></td></tr></table></figure></p>
<p>d) 安装依赖<br><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">npm i redux react-redux redux-saga react-router redux-form --save</div></pre></td></tr></table></figure></p>
<p>e) 启动项目<br><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">npm start</div></pre></td></tr></table></figure></p>
<p>f) 创建目录结构<br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">src/  </div><div class="line">  login/ <span class="comment"># 不同的容器对应不同的路由</span></div><div class="line">    sagas.js <span class="comment"># 存储跟api调用有关的saga</span></div><div class="line">    reducer.js <span class="comment"># 管理所有跟容器有关的状态</span></div><div class="line">    actions.js <span class="comment"># 提供给容器层分发任务的动作(action)</span></div><div class="line">    constants.js <span class="comment"># 对reducers/actions存储常量</span></div><div class="line">    index.js  <span class="comment"># 容器型组件</span></div><div class="line"></div><div class="line">  signup/</div><div class="line">    sagas.js</div><div class="line">    reducer.js</div><div class="line">    actions.js</div><div class="line">    constants.js</div><div class="line">    index.js</div><div class="line"></div><div class="line">  widgets/</div><div class="line">    sagas.js</div><div class="line">    reducer.js</div><div class="line">    actions.js</div><div class="line">    constants.js</div><div class="line">    index.js</div><div class="line"></div><div class="line">  client/</div><div class="line">    reducer.js</div><div class="line">    actions.js</div><div class="line">    constants.js</div><div class="line"></div><div class="line">  notifications/ <span class="comment"># 消息与错误的通知</span></div><div class="line">    Messages.js</div><div class="line">    Errors.js</div><div class="line"></div><div class="line">  lib/</div><div class="line">    api-errors.js <span class="comment"># 处理api调用错误</span></div><div class="line">    check-auth.js <span class="comment"># 当用户访问建立权限验证时应该被保护</span></div><div class="line"></div><div class="line">    index-reducer.js <span class="comment">#对reducer统一管理，方便compose</span></div><div class="line">    index-sagas.js  <span class="comment">#对saga统一管理</span></div></pre></td></tr></table></figure></p>
<h3 id="建立入口文件"><a href="#建立入口文件" class="headerlink" title="建立入口文件"></a>建立入口文件</h3><hr>
<h4 id="1-建立路由结构"><a href="#1-建立路由结构" class="headerlink" title="1. 建立路由结构"></a>1. 建立路由结构</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line">ReactDOM.render(  </div><div class="line">  &lt;Provider store=&#123;store&#125;&gt;</div><div class="line">    &lt;Router history=&#123;browserHistory&#125;&gt;</div><div class="line">      &lt;Route path="/" component=&#123;App&#125; &gt;</div><div class="line">        &lt;Route path="/login" component=&#123;Login&#125; /&gt;</div><div class="line">        &lt;Route path="/signup" component=&#123;Signup&#125; /&gt;</div><div class="line">        &lt;Route path="/widgets" component=&#123;Widgets&#125; /&gt;</div><div class="line">      &lt;/Route&gt;</div><div class="line">    &lt;/Router&gt;</div><div class="line">  &lt;/Provider&gt;,</div><div class="line">  document.getElementById('root'),</div><div class="line">)</div></pre></td></tr></table></figure>
<h4 id="2-建立中间件"><a href="#2-建立中间件" class="headerlink" title="2. 建立中间件"></a>2. 建立中间件</h4><figure class="highlight"><table><tr><td class="code"><pre><div class="line">// Import the index reducer and sagas</div><div class="line">import IndexReducer from './index-reducer'  </div><div class="line">import IndexSagas from './index-sagas</div><div class="line">const sagaMiddleware = createSagaMiddleware()</div></pre></td></tr></table></figure>
<h4 id="3-引入Redux-Devtools-Chrome-Extension"><a href="#3-引入Redux-Devtools-Chrome-Extension" class="headerlink" title="3. 引入Redux Devtools Chrome Extension"></a>3. 引入Redux Devtools Chrome Extension</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> composeSetup = process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">'object'</span> &amp;&amp;  </div><div class="line">  <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ ?</div><div class="line">  <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ : compose</div></pre></td></tr></table></figure>
<h4 id="4-开始saga"><a href="#4-开始saga" class="headerlink" title="4. 开始saga"></a>4. 开始saga</h4><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> store = createStore(  </div><div class="line">  IndexReducer,</div><div class="line">  composeSetup(applyMiddleware(sagaMiddleware)), <span class="comment">// 使用Redux Devtool 去跟踪saga</span></div><div class="line">)</div><div class="line"></div><div class="line">sagaMiddleware.run(IndexSagas)</div></pre></td></tr></table></figure>
<h3 id="Redux-Aside"><a href="#Redux-Aside" class="headerlink" title="Redux Aside"></a>Redux Aside</h3><hr>
<p>当然，在这里redux有点老生常谈了，言简意赅一下：</p>
<p>a) 提供一个全局store，去存储应用的state，这里与内部的state不冲突，这里比如一个国家，有很多个省。</p>
<p>b) 提供reducers给tore。就好比是每个省的省长，当遇到一些要改变省内状态的事情时，他们来决定是否接受或拒绝。</p>
<p>c) 通过</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&lt;provider store=&#123;store&#125;/&gt;</div></pre></td></tr></table></figure>
<p>传递，使得我们的应用能够拿到这个全局状态</p>
<p>d)app分发actions</p>
<p>e)对于reducers来说，如果action与他们有关，便会捕获，修正他们的状态(纯函数的方式)</p>
<p>f)当全局状态改变，被connected的app会接收这个改变，会再次渲染我们的react组件。</p>
<h3 id="组件设计"><a href="#组件设计" class="headerlink" title="组件设计"></a>组件设计</h3><hr>
<h4 id="1-The-Client-State"><a href="#1-The-Client-State" class="headerlink" title="1. The Client State"></a>1. The Client State</h4><p>client模块主要是保存用户登录之后的token信息，此token为JWT(后文详细介绍)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// client存储的初始state</span></div><div class="line"><span class="keyword">const</span> initialState = &#123;  </div><div class="line">  <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">token</span>: <span class="literal">null</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>设置action</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; CLIENT_SET, CLIENT_UNSET &#125; <span class="keyword">from</span> <span class="string">'./constants'</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setClient</span> (<span class="params">token</span>) </span>&#123;  </div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: CLIENT_SET,</div><div class="line">    token,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unsetClient</span> (<span class="params"></span>) </span>&#123;  </div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: CLIENT_UNSET,</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>设置reducer</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; CLIENT_SET, CLIENT_UNSET &#125; <span class="keyword">from</span> <span class="string">'./constants'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> initialSate = &#123;  </div><div class="line">  <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">token</span>: <span class="literal">null</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> reducer = <span class="function"><span class="keyword">function</span> <span class="title">clientReducer</span> (<span class="params">state = initialSate, action</span>) </span>&#123;  </div><div class="line">  <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">    <span class="keyword">case</span> CLIENT_SET:</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">id</span>: action.token.userId,</div><div class="line">        <span class="attr">token</span>: action.token,</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> CLIENT_UNSET:</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">        <span class="attr">token</span>: <span class="literal">null</span>,</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> state</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer</div></pre></td></tr></table></figure>
<h4 id="2-The-Signup-State"><a href="#2-The-Signup-State" class="headerlink" title="2. The Signup State"></a>2. The Signup State</h4><p>我们需要四种state来表示请求的过程，分别是</p>
<ul>
<li>requesting - 注册的请求</li>
<li>successful - 请求返回成功</li>
<li>errors - 请求返回失败</li>
<li>messages - 展示用户信息的数组</li>
</ul>
<p>接着，创建reducer<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; SIGNUP_REQUESTING &#125; <span class="keyword">from</span> <span class="string">'./constants'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> signupRequest = <span class="function"><span class="keyword">function</span> <span class="title">signupRequest</span> (<span class="params">&#123; email, password &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: SIGNUP_REQUESTING,</div><div class="line">    email,</div><div class="line">    password,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> signupRequest</div></pre></td></tr></table></figure></p>
<p>为了保持我们的actions是纯(pure)的,我们将所有异步的操作交给saga来完成。（与thunk不同的是，在这里saga将ations抽成了promises chain来处理）</p>
<h4 id="3-messages-error-view"><a href="#3-messages-error-view" class="headerlink" title="3. messages/error view"></a>3. messages/error view</h4><p>我们需要一个公用的组件来提示异步请求成功或者失败。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// src/notifications/messages.js</span></div><div class="line"><span class="keyword">import</span> React, &#123; PropTypes &#125; <span class="keyword">from</span> <span class="string">'react'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> Messages = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;  </div><div class="line">  <span class="keyword">const</span> &#123; messages &#125; = props</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    &lt;div&gt;</div><div class="line">      &lt;ul&gt;</div><div class="line">        &#123;messages.map(message =&gt; (</div><div class="line">          &lt;li key=&#123;message.time&#125;&gt;&#123;message.body&#125;&lt;/li&gt;</div><div class="line">        ))&#125;</div><div class="line">      &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  )</div><div class="line">&#125;</div><div class="line"></div><div class="line">Messages.propTypes = &#123;  </div><div class="line">  <span class="attr">messages</span>: PropTypes.arrayOf(</div><div class="line">      PropTypes.shape(&#123;</div><div class="line">        <span class="attr">body</span>: PropTypes.string,</div><div class="line">        <span class="attr">time</span>: PropTypes.date,</div><div class="line">      &#125;)),</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Messages</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">//src/notifications/Errors.js</span></div><div class="line"><span class="keyword">import</span> React, &#123; PropTypes &#125; <span class="keyword">from</span> <span class="string">'react'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> Errors = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;  </div><div class="line">  <span class="keyword">const</span> &#123; errors &#125; = props</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    &lt;div&gt;</div><div class="line">      &lt;ul&gt;</div><div class="line">        &#123;errors.map(errors =&gt; (</div><div class="line">          &lt;li key=&#123;errors.time&#125;&gt;&#123;errors.body&#125;&lt;/li&gt;</div><div class="line">        ))&#125;</div><div class="line">      &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  )</div><div class="line">&#125;</div><div class="line"></div><div class="line">Errors.propTypes = &#123;  </div><div class="line">  <span class="attr">errors</span>: PropTypes.arrayOf(</div><div class="line">      PropTypes.shape(&#123;</div><div class="line">        <span class="attr">body</span>: PropTypes.string,</div><div class="line">        <span class="attr">time</span>: PropTypes.date,</div><div class="line">      &#125;)),</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Errors</div></pre></td></tr></table></figure>
<h3 id="Redux-Form"><a href="#Redux-Form" class="headerlink" title="Redux-Form"></a>Redux-Form</h3><p>我们先花一点功夫介绍下redux-form。为什么要用redux-form呢？想象一下，如果用state来保存要提交的数据，用onChange来获取用户输入，然后改变state中相应数据荐，简直是梦魇一般。<strong>如果使用Redux跟Redux-form,redux用来管理状态，redux-form来负责表单数据部分。</strong></p>
<h4 id="1-redux-form主要特点"><a href="#1-redux-form主要特点" class="headerlink" title="1. redux-form主要特点"></a>1. redux-form主要特点</h4><ul>
<li>formReducer (reducer) :表单的各种操作以 Redux action 的方式，通过此 reducer 来促使 Redux store 数据的变化。</li>
<li>reduxForm() (HOC):属于react装饰器，此高阶组件用以整合 Redux action 绑定的用户交互与您的组件，并返回一个新的组件供以使用。</li>
<li><field>:一个Filed组件将用户输入与redux store相连接</field></li>
</ul>
<h4 id="2-数据流"><a href="#2-数据流" class="headerlink" title="2. 数据流"></a>2. 数据流</h4><p><img src="http://oum6ifofe.bkt.clouddn.com/image/reduxFormDiagram.png" alt="image"><br>数据流大概是这个样子的:</p>
<ol>
<li>用户点击这个 <figure class="highlight plain"><figcaption><span>组件,</span></figcaption><table><tr><td class="code"><pre><div class="line">2. &quot;Focus action&quot; 被触发,</div><div class="line">3. formReducer 更新了对应的状态,</div><div class="line">4. 这个状态被传回 ```&lt;input/&gt;</div></pre></td></tr></table></figure></li>
</ol>
<p>根据上面的数据流模型，我们搬出项目里的代码来分析：<br>第一步：Form reducer的添加<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">//index-reducer.js</span></div><div class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></div><div class="line"><span class="keyword">import</span> &#123; reducer <span class="keyword">as</span> form &#125; <span class="keyword">from</span> <span class="string">'redux-form'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> signup <span class="keyword">from</span> <span class="string">'./signup/reducer'</span></div><div class="line"> </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">const</span> IndexReducer = combineReducers(&#123;</div><div class="line">  signup,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> IndexReducer</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// index.js</span></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">  IndexReducer,</div><div class="line">  composeSetup(applyMiddleware(sagaMiddleware)), <span class="comment">// allows redux devtools to watch sagas</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>store需要知道组件如何发送action,因此我们需要在store中注册 formReducer，这样可以服务于整个app中你定义的所有表单组件，因此只需要注册一次。</p>
<p>第二步:建立 Form component</p>
<p>为了使表单组件可以与store进行交互，我们需要使用高价函数 reduxForm() 来包裹组件。他可以在执行提交表单等操作的时候，以props的方式提供表单内的state。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Signup</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">static</span> propTypes = &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render () &#123;</div><div class="line">    <span class="keyword">const</span> &#123;</div><div class="line">      handleSubmit,</div><div class="line">      <span class="attr">signup</span>: &#123;</div><div class="line">        requesting,</div><div class="line">        successful,</div><div class="line">        messages,</div><div class="line">        errors,</div><div class="line">      &#125;,</div><div class="line">    &#125; = <span class="keyword">this</span>.props</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div className="signup"&gt;</div><div class="line">        &#123;/* Use the Submit handler with our own submit handler*/&#125;</div><div class="line">        &lt;form className="widget-form" onSubmit=&#123;handleSubmit(this.submit)&#125;&gt;</div><div class="line">          //...</div><div class="line">        &lt;/form&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</div><div class="line">  <span class="attr">signup</span>: state.signup,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">const</span> connected = connect(mapStateToProps, &#123; signupRequest &#125;)(Signup)</div><div class="line"></div><div class="line"><span class="keyword">const</span> formed = reduxForm(&#123;</div><div class="line">  <span class="attr">form</span>: <span class="string">'signup'</span>,</div><div class="line">&#125;)(connected)</div><div class="line"></div><div class="line"><span class="comment">// Export our well formed component!</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> formed</div></pre></td></tr></table></figure></p>
<p>第三步：完善 Form <field> Components</field></p>
<p><field> 组件可以连接所有input类型组件的数据到store中，基本用法如下:<br><figure class="highlight"><table><tr><td class="code"><pre><div class="line">&lt;label htmlFor="email"&gt;Email&lt;/label&gt;</div><div class="line">&lt;Field</div><div class="line">   name="email"</div><div class="line">   type="text"</div><div class="line">   id="email"</div><div class="line">   className="email"</div><div class="line">   label="Email"</div><div class="line">   component="input"</div><div class="line">/&gt;</div></pre></td></tr></table></figure></field></p>
<blockquote>
<p>它创建了一个text类型的<figure class="highlight plain"><figcaption><span>value onChange,onBlur等属性，用于跟踪和维护此组件的各种状态。</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line">到第三步为止表单上的操作数据已经可以填充至store，并可以执行提交表单操作</div><div class="line"></div><div class="line">第四步：增加sumbit</div><div class="line">```js</div><div class="line">  // Form fields `email` and `password` when the form is submitted</div><div class="line">  // this will in turn call the action</div><div class="line">  submit = (values) =&gt; &#123;</div><div class="line">    console.log(values)</div><div class="line">    this.props.signupRequest(values)</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>提交的数据以JSON对象的形式注入了此表单组件的 onSubmit方法里了，可以打印出来看</p>
<h4 id="3-表单value的生命周期"><a href="#3-表单value的生命周期" class="headerlink" title="3. 表单value的生命周期"></a>3. 表单value的生命周期</h4><p><img src="https://github.com/erikras/redux-form/raw/master/docs/valueLifecycle.png" alt="image"></p>
<h4 id="4-API"><a href="#4-API" class="headerlink" title="4. API"></a>4. API</h4><p>这里只介绍本文使用的api，详细的api请移步<a href="http://redux-form.com/6.8.0/docs/api/" target="_blank" rel="external">官方文档</a></p>
<ul>
<li><p>reduxForm：可以通过配置一些参数创建表单修饰器，如配置表单验证，提交成功或者失败的回调，获取或者失去焦点的action发送，prop命名等。</p>
<ul>
<li><p>必要参数</p>
<p>form : 用于命名您的表单，在store生成此命名的数据节点。</p>
</li>
<li><p>可选参数</p>
<p>onChange : 表单触发 onChange 事件后的回调。</p>
<p>onSubmit : 表单提交配置，可以配置需要提交哪些参数，还有提交时触发的 dispatch等。</p>
<p>onSubmitSuccess  &amp; onSubmitFail :  提交表单成功和失败的回调。</p>
<p>shouldValidate: 同步验证。</p>
<p>shouldAsyncValidate: 异步验证。</p>
</li>
</ul>
</li>
<li><p>Field：所有需要与 store 数据连接的表单组件，都可以用 <field>。</field></p>
<ul>
<li>name：可以是简单的字符串，如 userName、password，也可以是复杂的结构。</li>
<li>component：可以是一个组件、无状态组件或者DOM所支持的默认的标签(input、textarea、select)。</li>
<li>其他所有属性会通过prop传递到元素生成器中。如 className</li>
</ul>
</li>
<li><p>reducer:表单的reducer用来安装Redux state 到表单中。</p>
<blockquote>
<p>如果您使用 Immutablejs 来管理您的 Redux state，你必须这么从 redux-form/immutable 中导入 reducer 模块。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></div><div class="line"><span class="keyword">import</span> &#123; reducer <span class="keyword">as</span> form &#125; <span class="keyword">from</span> <span class="string">'redux-form'</span></div><div class="line"> <span class="comment">// Or with Immutablejs:</span></div><div class="line"><span class="comment">// import &#123; reducer as form &#125; from 'redux-form/immutable'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">const</span> IndexReducer = combineReducers(&#123;</div><div class="line">  form,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> IndexReducer</div></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p>以上就是Redux-Form的基本介绍，到目前为止，我们完成了注册部分，如下图所示：<br><img src="http://oum6ifofe.bkt.clouddn.com/image/sagademo.jpg" alt="image"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>项目的基本搭建</li>
<li>redux的相关介绍</li>
<li><strong>Redux-Form的使用以及基本的原理</strong></li>
</ol>
<p>由于篇幅原因，基于Redux-Form与Redux-Saga的权限验证应用的第一系列就到此结束。基于Redux-Form与Redux-Saga的权限验证应用的第二系列，我们将详细介绍Redux-Saga在该项目中的应用，以及相关的原理。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><hr>
<p><a href="https://start.jcolemorrison.com/react-and-redux-sagas-authentication-app-tutorial/" target="_blank" rel="external">React and Redux Sagas Authentication App Tutorial</a></p>
<p><a href="https://juejin.im/entry/599174956fb9a03c5b04ce9e" target="_blank" rel="external">浅谈redux-form在项目中的运用</a></p>
<p><a href="http://react-china.org/t/react-redux-redux-form/13292" target="_blank" rel="external">React-Redux技术栈——之redux-form详解</a></p>

                <hr>
                

                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2017/08/15/Redux,Koa,Express之middleware机制对比/" data-toggle="tooltip" data-placement="top"
                           title="Redux,Koa,Express之middleware机制对比">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                


                <!--加入新的评论系统-->
                
            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目搭建"><span class="toc-text">项目搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-建立API"><span class="toc-text">1. 建立API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-建立脚手架"><span class="toc-text">2. 建立脚手架</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#建立入口文件"><span class="toc-text">建立入口文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-建立路由结构"><span class="toc-text">1. 建立路由结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-建立中间件"><span class="toc-text">2. 建立中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-引入Redux-Devtools-Chrome-Extension"><span class="toc-text">3. 引入Redux Devtools Chrome Extension</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-开始saga"><span class="toc-text">4. 开始saga</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redux-Aside"><span class="toc-text">Redux Aside</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#组件设计"><span class="toc-text">组件设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-The-Client-State"><span class="toc-text">1. The Client State</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-The-Signup-State"><span class="toc-text">2. The Signup State</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-messages-error-view"><span class="toc-text">3. messages/error view</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redux-Form"><span class="toc-text">Redux-Form</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-redux-form主要特点"><span class="toc-text">1. redux-form主要特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-数据流"><span class="toc-text">2. 数据流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-表单value的生命周期"><span class="toc-text">3. 表单value的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-API"><span class="toc-text">4. API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接"><span class="toc-text">参考链接</span></a></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#react"
                           title="react">react</a>
                        
                        <a class="tag" href="/tags/#redux-saga"
                           title="redux-saga">redux-saga</a>
                        
                        <a class="tag" href="/tags/#redux-form"
                           title="redux-form">redux-form</a>
                        
                        <a class="tag" href="/tags/#JWT"
                           title="JWT">JWT</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>

    </div>
</article>







<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/perkin">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/2432428362">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/perkinJ">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Perkin 2017
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://perkinj.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-100907186-1';
    var _gaDomain = 'perkinzone.cn';
    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>


<!-- Baidu Tongji -->

<script>
    var _baId = '46a74aa9d004724d9ee85ecffa1972f5';
    // Originial
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?" + _baId;
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','null','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="http://oum6ifofe.bkt.clouddn.com/image/avatar.jpg">
</body>

</html>
